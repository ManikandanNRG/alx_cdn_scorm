<style>
.local-alx-cdn-player-container {
    width: 100%;
    margin: 0;
    padding: 0;
    background: #000;
}
.scorm-frame-wrapper {
    width: 100%;
    position: relative;
    overflow: hidden;
    background: #000;
}
.scorm-frame-wrapper iframe {
    width: 100% !important;
    border: none;
    display: block;
    margin: 0;
    
    /* TRULY STATIC HEIGHT: 
       We use a fixed height for stability. 
       Articulate content needs a stable container to scale correctly internally.
    */
    {{#playerheight}}
    height: {{playerheight}} !important;
    {{/playerheight}}
    {{^playerheight}}
    height: 680px !important; 
    {{/playerheight}}
    
    /* Minor responsive adjustment ONLY - no dynamic growth */
    max-width: 100vw;
}

/* If mode is explicitly 'auto', use a fixed large standard instead of complex JS */
/* This prevents the "jitter" while scrolling */
.scorm-frame-wrapper.height-auto iframe {
    height: 85vh !important;
    min-height: 500px;
}
</style>

<div class="local-alx-cdn-player-container">
    <div class="scorm-frame-wrapper {{#playerheight}}height-{{playerheight}}{{/playerheight}}">
        <iframe id="scorm_object" 
                src="{{iframe_src}}" 
                frameborder="0" 
                allowfullscreen="allowfullscreen" 
                webkitallowfullscreen="webkitallowfullscreen" 
                mozallowfullscreen="mozallowfullscreen">
        </iframe>
    </div>
</div>

<script>
// Inline Bridge Controller (Professional, Full-Feature & Stable)
(function() {
    var state = {
        scormid: {{{bridge_scormid}}},
        scoid: {{{bridge_scoid}}},
        cmid: {{{bridge_cmid}}},
        attempt: {{{bridge_attempt}}},
        debug: {{{bridge_debug}}},
        wwwroot: '{{{bridge_wwwroot}}}',
        sesskey: '{{{bridge_sesskey}}}',
        playerheight: '{{playerheight}}',
        is_auto: {{#is_auto}}true{{/is_auto}}{{^is_auto}}false{{/is_auto}},
        data: {{{scorm_data_json}}}
    };
    
    var log = function(msg) {
        if (state.debug && console && console.log) {
            console.log("[Bridge] " + msg);
        }
    };
    
    log("SCORM data initialized");
    
    var getValue = function(element) {
        return state.data[element] || "";
    };
    
    var setValue = function(element, value) {
        state.data[element] = value;
        return "true";
    };
    
    var saveRetryCount = 0;
    var maxRetries = 3;
    var retryDelay = 2000; 
    
    var commit = function(isRetry) {
        if (!isRetry) saveRetryCount = 0;
        
        log("Committing data...");
        
        // Mastery Score Override logic
        var masteryoverride = {{masteryoverride}};
        var lessonMode = state.data['cmi.core.lesson_mode'] || '{{mode}}';
        var credit = state.data['cmi.core.credit'] || '';
        
        if (masteryoverride && lessonMode === 'normal' && credit === 'credit') {
            var masteryScore = state.data['cmi.student_data.mastery_score'];
            var rawScore = state.data['cmi.core.score.raw'];
            if (masteryScore && rawScore) {
                if (parseFloat(rawScore) >= parseFloat(masteryScore)) {
                    state.data['cmi.core.lesson_status'] = 'passed';
                } else {
                    state.data['cmi.core.lesson_status'] = 'failed';
                }
            }
        }
        
        var tracks = [];
        for (var key in state.data) {
            if (key.indexOf('cmi.') === 0 || key.indexOf('cmi_') === 0) {
                tracks.push({ element: key, value: state.data[key] });
            }
        }
        
        if (tracks.length === 0) return "true";
        
        require(['core/ajax'], function(Ajax) {
            Ajax.call([{
                methodname: 'local_alx_cdn_scorm_save_tracks',
                args: {
                    scormid: state.scormid,
                    scoid: state.scoid,
                    attempt: state.attempt,
                    tracks: tracks
                }
            }])[0].done(function(response) {
                log("Save success");
                saveRetryCount = 0;
                updateTOC();
            }).fail(function(ex) {
                log("Save FAILED");
                if (saveRetryCount < maxRetries) {
                    saveRetryCount++;
                    setTimeout(function() { commit(true); }, retryDelay);
                }
            });
        });
        
        return "true";
    };
    
    var updateTOC = function() {
        var hidetoc = '{{hidetoc}}';
        if (hidetoc === '3') return;
        if (typeof M !== 'undefined' && M.mod_scorm && M.mod_scorm.connectPrereqCallback) {
            var prerequrl = '{{{bridge_wwwroot}}}/mod/scorm/prereqs.php?a={{bridge_scormid}}&scoid={{bridge_scoid}}&attempt={{bridge_attempt}}&mode={{mode}}&currentorg={{currentorg}}&sesskey={{bridge_sesskey}}';
            require(['core/yui'], function(Y) {
                Y.use('io-base', function(Y) {
                    var callback = M.mod_scorm.connectPrereqCallback;
                    Y.on('io:complete', callback.success, Y);
                    Y.io(prerequrl);
                });
            });
        }
    };
    
    var launchNextSCO = function() {
        if (typeof mod_scorm_launch_next_sco === 'function') mod_scorm_launch_next_sco();
        else if (window.parent && typeof window.parent.mod_scorm_launch_next_sco === 'function') window.parent.mod_scorm_launch_next_sco();
    };

    // SCORM 1.2 API
    var ScormAPI = {
        LMSInitialize: function(p) { return "true"; },
        LMSFinish: function(p) {
            commit();
            var navEvent = getValue('nav.event') || '';
            var scormauto = {{scormauto}};
            if (navEvent === 'continue' || scormauto == 1) setTimeout(launchNextSCO, 500);
            return "true";
        },
        LMSGetValue: getValue,
        LMSSetValue: setValue,
        LMSCommit: commit,
        LMSGetLastError: function() { return "0"; },
        LMSGetErrorString: function() { return "No error"; },
        LMSGetDiagnostic: function() { return "No diagnostic"; }
    };
    
    // SCORM 2004 API
    var ScormAPI2004 = {
        Initialize: function(p) { return "true"; },
        Terminate: function(p) { return ScormAPI.LMSFinish(p); },
        GetValue: getValue,
        SetValue: setValue,
        Commit: commit,
        GetLastError: function() { return "0"; },
        GetErrorString: function() { return "No error"; },
        GetDiagnostic: function() { return "No diagnostic"; }
    };
    
    // Expose APIs
    window.API = ScormAPI;
    window.API_1484_11 = ScormAPI2004;
    
    window.addEventListener("message", function(event) {
        try {
            var msg = JSON.parse(event.data);
            if (msg.source !== 'scorm_content') return;
            var res = { source: 'scorm_bridge', id: msg.id, result: "true" };
            
            // Map both standard and 2004 types
            switch (msg.type) {
                case 'LMSInitialize': case 'Initialize': res.result = "true"; break;
                case 'LMSGetValue': case 'GetValue': res.result = getValue(msg.element); break;
                case 'LMSSetValue': case 'SetValue': res.result = setValue(msg.element, msg.value); break;
                case 'LMSCommit': case 'Commit': res.result = commit(); break;
                case 'LMSFinish': case 'Terminate': res.result = ScormAPI.LMSFinish(); break;
            }
            event.source.postMessage(JSON.stringify(res), "*");
        } catch (e) {}
    }, false);
    
    setInterval(function() { if (Object.keys(state.data).length > 0) commit(); }, 30000);
    window.addEventListener("beforeunload", function() { commit(); });
    
    log("Bridge Controller Ready (Fixed Height: " + (state.is_auto ? 'Auto' : state.playerheight) + ")");
})();
</script>
